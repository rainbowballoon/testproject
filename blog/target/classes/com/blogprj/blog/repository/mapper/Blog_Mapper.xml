<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.blogprj.blog.repository.mapper.Blog_Mapper">

<!-- member -->

	 <insert id="blogJoin" parameterType="com.blogprj.blog.model.Member_DTO" useGeneratedKeys="true" keyColumn="no" keyProperty="no">
		<selectKey keyProperty="no" resultType="int" order="BEFORE">			   
	    	SELECT member_seq.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO MEMBER 
		(
			no, id, pw, domain, nickname, birthday, regdate
		)
		VALUES 
		(
			#{no}, #{id}, #{pw}, #{domain}, #{nickname}, #{birthday}, sysdate
		)
	</insert>

	<select id="blogLogin" parameterType="com.blogprj.blog.model.Member_DTO" resultMap="blogLoginMap">
 		SELECT 
 			m.no, m.id, m.pw, m.nickname, m.birthday, m.domain, m.regdate,
 			b.no AS bno, 
 			b.title AS btitle, 
 			b.proimg AS bproimg, 
 			b.profile AS bprofile, 
 			b.memberno AS bmemberno, 
 			b.layoutno AS blayoutno, 
 			b.themeno AS bthemeno,
 			c.no AS cno,
 			c.name AS cname,
 			c.blogno AS cblogno,
 			sc.no AS scno,
 			sc.name AS scname,
 			sc.categoryno AS sccategoryno,
 			sc.blogno AS scblogno
    	FROM MEMBER m
    		LEFT JOIN BLOG b ON b.memberno = m.no
    		LEFT JOIN CATEGORY c ON c.blogno = b.no
    		LEFT JOIN SUBCATEGORY sc ON sc.blogno = b.no
    	WHERE m.id = #{id} AND m.pw = #{pw}
 	</select>
 	
 	<resultMap type="com.blogprj.blog.model.Member_DTO" id="blogLoginMap">
 		<id property="no" column="no" />
 		<result column="id" property="id"/>
 		<result column="pw" property="pw"/>
 		<result column="nickname" property="nickname"/>
 		<result column="birthday" property="birthday"/>
 		<result column="domain" property="domain"/>
 		<result column="regdate" property="regdate"/>
 		<association property="bDTO" column="no" javaType="com.blogprj.blog.model.Blog_DTO">
 			<id column="bno" property="no"/>
	 		<result column="btitle" property="title"/>
	 		<result column="bproimg" property="proimg"/>
	 		<result column="bprofile" property="profile"/>
	 		<result column="blayoutno" property="layoutno"/>
	 		<result column="bmemberno" property="memberno"/>
	 		<result column="bthemeno" property="themeno"/>
	 		<association property="cDTO" column="bno" javaType="com.blogprj.blog.model.Category_DTO">
	 			<id column="cno" property="no"/>
		 		<result column="cname" property="name"/>
		 		<result column="cblogno" property="blogno"/>
	 		</association>
	 		<association property="scDTO" column="bno" javaType="com.blogprj.blog.model.SubCategory_DTO">
	 			<id column="scno" property="no"/>
		 		<result column="scname" property="name"/>
		 		<result column="sccategoryno" property="categoryno"/>
		 		<result column="scblogno" property="blogno"/>
	 		</association>
 		</association>
 	</resultMap>
    
<!-- blog	 -->
	<insert id="blogCreate" parameterType="com.blogprj.blog.model.Member_DTO">
		INSERT INTO BLOG
		(
			no, memberno
		)
		VALUES 
		(
			blog_seq.nextval, #{memberno}
		)
	</insert>
	
	<select id="getBlogno" parameterType="int" resultType="int">
    	SELECT no 
    	FROM BLOG 
    	WHERE memberno = #{memberno}
    </select>
    
    <select id="blogProfileRead" parameterType="int" resultType="com.blogprj.blog.model.Blog_DTO">
    	SELECT * 
    	FROM BLOG 
    	WHERE memberno = #{memberno}
    </select>
    
	<update id="blogProfileUpdate" parameterType="com.blogprj.blog.model.Blog_DTO">
		UPDATE BLOG SET 
		title = #{title}, proimg = #{proimg}, profile = #{profile}
		WHERE memberno = #{memberno}
	</update>
	
	<update id="blogThemeUpdate" parameterType="com.blogprj.blog.model.Blog_DTO">
		UPDATE BLOG SET 
		themeno = #{themeno}
		WHERE memberno = #{memberno}
	</update>
	
	<select id="blogThemeView" parameterType="int" resultType="int">
		SELECT themeno 
    	FROM BLOG 
    	WHERE memberno = #{memberno}
	</select>
	
	<update id="blogLayoutUpdate" parameterType="com.blogprj.blog.model.Blog_DTO">
		UPDATE BLOG SET 
		layoutno = #{layoutno}
		WHERE memberno = #{memberno}
	</update>
	
	<select id="blogLayoutView" parameterType="int" resultType="int">
		SELECT layoutno 
    	FROM BLOG 
    	WHERE layoutno = #{layoutno}
	</select>
	
<!-- post  -->
     <insert id="postWrite" parameterType="com.blogprj.blog.model.Post_DTO">
		INSERT INTO POST 
		(
			no, regdate, title, content, blogno, memberno, postaccess, topicno, subcategoryno
		)
		VALUES 
		(
			post_seq.nextval, sysdate, #{title}, #{content}, #{blogno}, #{memberno}, #{postaccess}, #{topicno}, #{subcategoryno}
		)
	</insert>
	
	<select id="selectPostCount" parameterType="int" resultType="int">
    	SELECT count(*) FROM POST
    	WHERE blogno = #{blogno} 
    </select>
    
    <select id="selectPostCategoryCount" parameterType="hashmap" resultType="int">
    	SELECT count(*)
    	FROM POST p
    	JOIN SUBCATEGORY sc ON sc.no = p.subcategoryno
    	WHERE p.blogno = #{blogno} AND sc.categoryno = #{categoryno}
    </select>
    
    <select id="selectPostSubCategoryCount" parameterType="hashmap" resultType="int">
    	SELECT count(*) FROM POST
    	WHERE blogno = #{blogno} AND subcategoryno = #{subcategoryno}
    </select>
    
    <select id="postList" parameterType="hashmap" resultType="com.blogprj.blog.model.Post_DTO">
	    SELECT *
	  	FROM (
	            select rownum as rnum, no, regdate, title, content, blogno, memberno, postaccess, topicno, subcategoryno
	            from POST
	            WHERE blogno = #{blogno}
	         ) 
	    WHERE <![CDATA[rnum >= #{sPage}+1]]> AND <![CDATA[ rnum <= #{ePage}+#{sPage} ]]>
	    ORDER BY regdate DESC
    </select>
    
    <select id="postCategoryList" parameterType="hashmap" resultMap="postCategoryListMap">
    	SELECT *
    	FROM (
		    SELECT rownum as rnum, p.no, p.regdate, p.title, p.content, p.blogno, p.memberno, p.postaccess, p.topicno, p.subcategoryno,
			sc.no AS scno, sc.name AS scname, sc.categoryno AS sccategoryno, sc.blogno AS scblogno	    
		    FROM POST p
		    JOIN SUBCATEGORY sc ON sc.no = p.subcategoryno
		    WHERE p.blogno = #{blogno} AND sc.categoryno = #{categoryno}
		    )
		WHERE <![CDATA[rnum >= #{sPage}+1]]> AND <![CDATA[ rnum <= #{ePage}+#{sPage} ]]>
	    ORDER BY regdate DESC
    </select>
    
    <resultMap type="com.blogprj.blog.model.Post_DTO" id="postCategoryListMap">
    	<id property="no" column="no"/>
    	<result property="regdate" column="regdate"/>
    	<result property="title" column="title"/>
    	<result property="content" column="content"/>
    	<result property="blogno" column="blogno"/>
    	<result property="memberno" column="memberno"/>
    	<result property="postaccess" column="postaccess"/>
    	<result property="topicno" column="topicno"/>
    	<result property="subcategoryno" column="subcategoryno"/>
    	<association property="scDTO" column="subcategoryno" javaType="com.blogprj.blog.model.SubCategory_DTO">
    		<id property="no" column="scno"/>
	    	<result property="name" column="scname"/>
	    	<result property="categoryno" column="sccategoryno"/>
	    	<result property="blogno" column="scblogno"/>
    	</association>
    </resultMap>
    
     <select id="postSubCategoryList" parameterType="hashmap" resultType="com.blogprj.blog.model.Post_DTO">
	    SELECT *
	  	FROM (
	            select rownum as rnum, no, regdate, title, content, blogno, memberno, postaccess, topicno, subcategoryno
	            from POST
	            WHERE blogno = #{blogno} AND subcategoryno = #{subcategoryno}
	         ) 
	    WHERE <![CDATA[rnum >= #{sPage}+1]]> AND <![CDATA[ rnum <= #{ePage}+#{sPage} ]]>
	    ORDER BY regdate DESC
    </select>
    
    <select id="postDetail" parameterType="com.blogprj.blog.model.Post_DTO" resultType="com.blogprj.blog.model.Post_DTO">
    	SELECT *
    	FROM POST
    	WHERE no = #{no} AND blogno = #{blogno} 
    </select>
    
    <update id="postEdit" >
   		UPDATE POST SET 
			title = #{title} , content = #{content}, blogno = #{blogno}, memberno = #{memberno}, 
			postaccess = #{postaccess}, topicno = #{topicno}, subcategoryno=#{subcategoryno}
		WHERE no = #{no} AND blogno = #{blogno} AND memberno = #{memberno}
    </update>
    
    <delete id="postDelete">
   		DELETE FROM POST 
		WHERE no = #{no} AND blogno = #{blogno}
    </delete>

 	<select id="breadCrumbC" parameterType="int" resultType="com.blogprj.blog.model.Category_DTO">
		SELECT DISTINCT c.name
		FROM category c
		JOIN subcategory sc ON c.NO = sc.CATEGORYNO
		WHERE c.NO = #{categoryno}
    </select>
    
    <select id="breadCrumbSC" parameterType="int" resultMap="breadCrumbSCMap">
		SELECT DISTINCT sc.name, c.name AS cname
		FROM subcategory sc
		JOIN category c ON c.NO = sc.CATEGORYNO
		WHERE sc.NO = #{subcategoryno}
    </select>
    
    <resultMap type="com.blogprj.blog.model.SubCategory_DTO" id="breadCrumbSCMap">
    	<id property="no" column="no"/>
    	<result property="name" column="name"/>
    	<association property="cDTO" column="categoryno" javaType="com.blogprj.blog.model.Category_DTO">
    		<id property="no" column="cno"/>
	    	<result property="name" column="cname"/>
    	</association>
    </resultMap>

<!-- commnets_ps-->
	<insert id="commentsPSWrite" parameterType="com.blogprj.blog.model.Comments_PS_DTO">
		INSERT INTO COMMENTS_PS
		(
			no, postno, memberno, regdate, content
		)
		VALUES 
		(
			 comments_ps_seq.nextval, #{postno}, #{memberno}, sysdate, #{content}
		)
	</insert>
    
    <select id="commentsPSList" parameterType="int" resultType="com.blogprj.blog.model.Comments_PS_DTO">
 		SELECT *
    	FROM COMMENTS_PS
    	WHERE postno = #{postno}
    	ORDER BY regdate DESC
 	</select>
 	
 	<delete id="commentsPSDelete" parameterType="int">
   		DELETE FROM COMMENTS_PS 
		WHERE no = #{no}
    </delete>

	<select id="commentsPSCount" parameterType="int" resultType="int">
 		SELECT count(*) FROM COMMENTS_PS
    	WHERE postno = #{postno}
 	</select> 
 	
<!-- commnets_bd-->
	<insert id="commentsBDWrite" parameterType="com.blogprj.blog.model.Comments_BD_DTO">
		INSERT INTO COMMENTS_BD
		(
			no, boardno, memberno, regdate, content
		)
		VALUES 
		(
			 comments_bd_seq.nextval, #{boardno}, #{memberno}, sysdate, #{content}
		)
	</insert>
    
    <select id="commentsBDList" parameterType="int" resultType="com.blogprj.blog.model.Comments_BD_DTO">
 		SELECT *
    	FROM COMMENTS_BD
    	WHERE boardno = #{boardno}
    	ORDER BY regdate DESC
 	</select>
 	
 	<delete id="commentsBDDelete" parameterType="int">
   		DELETE FROM COMMENTS_BD 
		WHERE no = #{no}
    </delete>	   

	<select id="commentsBDCount" parameterType="int" resultType="int">
 		SELECT count(*) FROM COMMENTS_BD
    	WHERE boardno = #{boardno}
 	</select> 	
 		    
<!-- category     -->
	<select id="categoryList" parameterType="int" resultType="com.blogprj.blog.model.Category_DTO">
    	SELECT * 
    	FROM CATEGORY 
    	WHERE blogno = #{blogno}
    	ORDER BY no
    </select>
    
    <insert id="categoryWrite" parameterType="com.blogprj.blog.model.Category_DTO">
    	INSERT INTO CATEGORY 
		(
			no, name, blogno
		)
		VALUES 
		(
			category_seq.nextval, #{name}, #{blogno}
		)
    </insert>
    
    <update id="categoryEdit" parameterType="com.blogprj.blog.model.Category_DTO">
		UPDATE CATEGORY 
		SET 
		name=#{name}
		WHERE no = #{no}
	</update>
	
	<delete id="categoryDelete">
		DELETE FROM CATEGORY WHERE no = #{no}
	</delete>
	
	 <select id="categoryDetail" parameterType="int" resultType="com.blogprj.blog.model.Category_DTO">
    	SELECT 	
    		NO, NAME, BLOGNO
		FROM CATEGORY
		WHERE NO = #{no}
    </select>
 	
<!-- subcategory     -->

	<select id="subCategoryListAll" parameterType="int" resultType="com.blogprj.blog.model.SubCategory_DTO">
    	SELECT * 
    	FROM SUBCATEGORY 
    	WHERE blogno = #{blogno}
    </select>
	
	<select id="subCategoryList" parameterType="hashmap" resultType="com.blogprj.blog.model.SubCategory_DTO">
    	SELECT * 
    	FROM SUBCATEGORY 
    	WHERE blogno = #{blogno} AND categoryno = #{categoryno}
    </select>
	
	<insert id="subCategoryWrite" parameterType="com.blogprj.blog.model.SubCategory_DTO">
    	INSERT INTO SUBCATEGORY 
		(
			no, name, categoryno, blogno
		)
		VALUES 
		(
			subcategory_seq.nextval, #{name}, #{categoryno}, #{blogno}
		)
    </insert>
	
	<select id="subCategoryDetail" parameterType="hashmap" resultType="com.blogprj.blog.model.SubCategory_DTO">
    	SELECT 	
    		NO, NAME, CATEGORYNO, BLOGNO
		FROM SUBCATEGORY
		WHERE no = #{no} AND blogno = #{blogno} AND categoryno = #{categoryno}
    </select>
    
    <update id="subCategoryEdit" parameterType="com.blogprj.blog.model.SubCategory_DTO">
		UPDATE SUBCATEGORY 
		SET 
		name=#{name}
		WHERE no = #{no} AND blogno = #{blogno} AND categoryno = #{categoryno}
	</update>
	
    <delete id="subCategoryDelete">
		DELETE FROM SUBCATEGORY 
		WHERE no = #{no} AND blogno = #{blogno} AND categoryno = #{categoryno}
	</delete>
	
 	<select id="subCategoryCount" parameterType="com.blogprj.blog.model.SubCategory_DTO" resultType="int">
    	SELECT count(*) FROM SUBCATEGORY
    	WHERE blogno = #{blogno} AND categoryno = #{categoryno}
    </select>
	
    <select id="test" resultType="com.blogprj.blog.model.Test_DTO">
    	SELECT * FROM TEST1
    </select>
    
<!-- bloginfo  -->
 	<select id="blogInfo" parameterType="com.blogprj.blog.model.Member_DTO" resultMap="blogInfoMap">
 		SELECT 
 			m.no, m.id, m.nickname, m.birthday, m.domain, m.regdate,
 			b.no AS bno, 
 			b.title AS btitle, 
 			b.proimg AS bproimg, 
 			b.profile AS bprofile, 
 			b.memberno AS bmemberno, 
 			b.layoutno AS blayoutno, 
 			b.themeno AS bthemeno
    	FROM MEMBER m
    		LEFT JOIN BLOG b ON m.no = b.memberno
    	WHERE m.no = #{memberno}
 	</select>
 	
 	<resultMap type="com.blogprj.blog.model.Member_DTO" id="blogInfoMap">
 		<id property="no" column="no" />
 		<result column="id" property="id"/>
 		<result column="nickname" property="nickname"/>
 		<result column="birthday" property="birthday"/>
 		<result column="domain" property="domain"/>
 		<result column="regdate" property="regdate"/>
 		<association property="bDTO" column="no" javaType="com.blogprj.blog.model.Blog_DTO">
 			<id column="bno" property="no"/>
	 		<result column="btitle" property="title"/>
	 		<result column="bproimg" property="proimg"/>
	 		<result column="bprofile" property="profile"/>
	 		<result column="blayoutno" property="layoutno"/>
	 		<result column="bmemberno" property="memberno"/>
	 		<result column="bthemeno" property="themeno"/>
 		</association>
 	</resultMap>

<!-- board -->    
	<select id="boardList" parameterType="int" resultMap="boardlistMap">
	    SELECT 
	    	b.no, 
	    	b.memberno, 
	    	b.groupid, 
	    	b.relevel, 
	    	b.redepth, 
	    	b.title, 
	    	b.content, 
	    	b.useyn, 
	    	b.regdate, 
	    	b.editdate, 
	    	b.blogno, 
      	  	cbd.boardno AS cbdboardno,
	    	(SELECT count(*) FROM COMMENTS_BD WHERE COMMENTS_BD.boardno = b.no ) AS cbdcount 
	  	FROM board b
	  	LEFT OUTER JOIN COMMENTS_BD cbd ON cbd.boardno = b.no
	    ORDER BY b.regdate DESC, b.groupid DESC, b.relevel ASC
    </select>
    
    <resultMap type="com.blogprj.blog.model.Board_DTO" id="boardlistMap">
    	<id property="no" column="no" />
    	<result column="memberno" property="memberno"/>
    	<result column="groupid" property="groupid"/>
    	<result column="relevel" property="relevel"/>
    	<result column="redepth" property="redepth"/>
    	<result column="title" property="title"/>
    	<result column="content" property="content"/>
    	<result column="useyn" property="useyn"/>
    	<result column="regdate" property="regdate"/>
    	<result column="editdate" property="editdate"/>
    	<result column="blogno" property="blogno"/>
    	<association property="cbdDTO" column="no" javaType="com.blogprj.blog.model.Comments_BD_DTO">
    		<id column="cno" property="no"/>
    		<result column="cbdboardno" property="boardno"/>
    		<result column="cbdcount" property="cbdcount"/>
    	</association>
    </resultMap>
    
    <insert id="boardWrite" parameterType="com.blogprj.blog.model.Board_DTO">
   		<selectKey keyProperty="no" resultType="int" order="BEFORE">			   
	    	SELECT board_seq.NEXTVAL FROM DUAL
		</selectKey>
		
    	INSERT INTO BOARD(
    		no, memberno, groupid, relevel, redepth, title, 
    		content, useyn, regdate, editdate, blogno
    	)VALUES(
    		#{no}, #{memberno}, #{no}, #{relevel}, #{redepth}, #{title}, 
    		#{content}, #{useyn}, sysdate, sysdate, #{blogno}
    	)
    </insert>
    
    <select id="boardInfo" parameterType="int" resultType="com.blogprj.blog.model.Board_DTO">
    	SELECT *
	  	FROM board 
	    WHERE no = #{no}
    </select>
    
    <update id="boardEdit" parameterType="com.blogprj.blog.model.Board_DTO">
		UPDATE BOARD 
		SET 
		title = #{title}, content = #{content}, useyn = #{useyn}, editdate = sysdate
		WHERE no = #{no}
	</update>
</mapper>
